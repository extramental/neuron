<!doctype html>
<html>
    <head>
        <title>Concurrent Editing</title>
    </head>
    <body>
        <textarea id="document" cols="30" rows="10"></textarea>
        <script src="bower_components/google-diff-match-patch-js/diff_match_patch.js"></script>
        <script src="bower_components/sockjs-client/sockjs.min.js"></script>
        <script src="bower_components/lodash/lodash.js"></script>
        <script src="bower_components/ot/dist/ot.js"></script>
        <script src="bower_components/codemirror/lib/codemirror.js"></script>
        <link rel="stylesheet" href="bower_components/codemirror/lib/codemirror.css">
        <script>
            var doc = document.getElementById("document");
            var uid = Math.floor(Math.random() * 100);

            var cm = CodeMirror.fromTextArea(doc, {
                lineNumbers: true
            });
            var cma = new ot.CodeMirrorAdapter(cm);

            var ops = {
                AUTH: 0,
                LOAD: 1,
                CONTENT: 2,
                OPERATION: 3,
                ACK: 4
            };

            var dmp = new diff_match_patch();

            function serializeOp(o) {
                return JSON.stringify(o.ops);
            }

            function deserializeOp(v) {
                return ot.TextOperation.fromJSON(JSON.parse(v));
            }

            function makeTextOperation(orig, new_) {
                var diff = dmp.diff_main(orig, new_);
                dmp.diff_cleanupSemantic(diff);

                var o = new ot.TextOperation();

                diff.forEach(function (x) {
                    switch (x[0]) {
                        case 0:
                            o.retain(x[1].length);
                            break;
                        case 1:
                            o.insert(x[1]);
                            break;
                        case -1:
                            o['delete'](x[1].length);
                            break;
                    }
                });

                return o;
            }

            var OP_MAP = {};
            OP_MAP[ops.AUTH] = function () {
                sock.send(JSON.stringify([ops.LOAD, "test_doc"]));

                OP_MAP[ops.CONTENT] = function (id, rev, body) {
                    var cdoc = new ot.Client(rev + 1);
                    cm.setValue(body);

                    cdoc.sendOperation = function (rev, op) {
                        sock.send(JSON.stringify([ops.OPERATION, id, rev, serializeOp(op)]));
                    };

                    cdoc.applyOperation = function(op) {
                        cma.applyOperation(op);
                    }

                    cma.registerCallbacks({
                        change: function (c) {
                            cdoc.applyClient(c);
                        }
                    });

                    OP_MAP[ops.ACK] = function (id) {
                        cdoc.serverAck();
                    };

                    OP_MAP[ops.OPERATION] = function (id, rawOp) {
                        cdoc.applyServer(deserializeOp(rawOp));
                    };
                };
            };

            var sock = new SockJS("http://localhost:8080/");
            sock.onopen = function () {
                sock.send(JSON.stringify([ops.AUTH, uid]));
            };

            sock.onmessage = function (e) {
                var payload = JSON.parse(e.data);
                OP_MAP[payload[0]].apply(null, payload.slice(1));
            };

            sock.onclose = function () {
                console.error("died");
            };
        </script>
    </body>
</html>
