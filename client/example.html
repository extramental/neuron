<!doctype html>
<html>
    <head>
        <title>Concurrent Editing</title>
    </head>
    <body>
        <textarea id="document" cols="30" rows="10"></textarea>
        <script src="bower_components/sockjs-client/sockjs.min.js"></script>
        <script src="bower_components/lodash/lodash.js"></script>
        <script src="bower_components/ot/dist/ot.js"></script>
        <script src="bower_components/codemirror/lib/codemirror.js"></script>
        <link rel="stylesheet" href="bower_components/codemirror/lib/codemirror.css">
        <script>
            var doc = document.getElementById("document");
            var editorId = 1;

            var cm = CodeMirror.fromTextArea(doc, {
                lineNumbers: true
            });
            var client;

            var ops = {
                AUTH: 0,
                LOAD: 1,
                CONTENT: 2,
                OPERATION: 3,
                ACK: 4,
                CURSOR: 5,
                LEFT: 6
            };

            function serializeOp(o) {
                return JSON.stringify(o.ops);
            }

            function deserializeOp(v) {
                return ot.TextOperation.fromJSON(JSON.parse(v));
            }

            var OP_MAP = {};
            OP_MAP[ops.AUTH] = function () {
                sock.send(JSON.stringify([ops.LOAD, "test_doc"]));

                OP_MAP[ops.CONTENT] = function (id, rev, clients, body) {
                    cm.setValue(body);

                    var sockAdapter = {
                        sendOperation: function (rev, op, cursor) {
                            sock.send(JSON.stringify([ops.OPERATION, id, rev, JSON.stringify(op)]));
                            sockAdapter.sendCursor(cursor);
                        },

                        sendCursor: function (cursor) {
                            if (cursor) {
                                sock.send(JSON.stringify([ops.CURSOR, id, cursor.position + "," + cursor.selectionEnd]));
                            } else {
                                sock.send(JSON.stringify([ops.CURSOR, id, null]));
                            }
                        },

                        registerCallbacks: function (cb) {
                            OP_MAP[ops.OPERATION] = function (id, rawOp) {
                                cb.operation(JSON.parse(rawOp));
                            };

                            OP_MAP[ops.ACK] = function (id) {
                                cb.ack();
                            };

                            OP_MAP[ops.CURSOR] = function (id, uid, cursor) {
                                if (cursor !== null) {
                                    cursor = cursor.split(",");
                                    cursor = {
                                        position: parseInt(cursor[0], 10),
                                        selectionEnd: parseInt(cursor[1], 10)
                                    };
                                }
                                cb.cursor(uid, cursor);
                            };


                            OP_MAP[ops.LEFT] = function (id, uid) {
                                cb.client_left(uid);
                            };

                            this.cb = cb;
                        }
                    };

                    client = new ot.EditorClient(
                        rev + 1,
                        clients.reduce(function (acc, x) {
                            acc[x] = {name: x};
                            return acc;
                        }, {}),
                        sockAdapter,
                        new ot.CodeMirrorAdapter(cm)
                    );
                };
            };

            var sock = new SockJS("http://localhost:8080/");
            sock.onopen = function () {
                sock.send(JSON.stringify([ops.AUTH, editorId]));
            };

            sock.onmessage = function (e) {
                var payload = JSON.parse(e.data);
                OP_MAP[payload[0]].apply(null, payload.slice(1));
            };

            sock.onclose = function () {
                console.error("died");
            };
        </script>
    </body>
</html>
